From 3173d5bb8f851a8468eb9cdced5d0c0f65fa44af Mon Sep 17 00:00:00 2001
From: Martin Geier <martin.geier@streamunlimited.com>
Date: Wed, 5 Jul 2017 12:11:47 +0200
Subject: [PATCH] googlecast: fixed various compilation warnings in
 libdbus-c++

Signed-off-by: Stanislav Ruzani <stanislav.ruzani@streamunlimited.com>
---
 include/dbus-c++/error.h |  2 +-
 src/dispatcher.cpp       | 10 ++--------
 src/eventloop.cpp        |  4 ++--
 3 files changed, 5 insertions(+), 11 deletions(-)

diff --git a/include/dbus-c++/error.h b/include/dbus-c++/error.h
index 57a6471..167607f 100644
--- a/include/dbus-c++/error.h
+++ b/include/dbus-c++/error.h
@@ -34,7 +34,7 @@ namespace DBus
 {
 
 class Message;
-class InternalError;
+struct DXXAPI InternalError;
 
 class DXXAPI Error : public std::exception
 {
diff --git a/src/dispatcher.cpp b/src/dispatcher.cpp
index bc07d71..7eecee9 100644
--- a/src/dispatcher.cpp
+++ b/src/dispatcher.cpp
@@ -72,14 +72,7 @@ int Watch::descriptor() const
 #if HAVE_WIN32
   return dbus_watch_get_socket((DBusWatch *)_int);
 #else
-  // check dbus version and use dbus_watch_get_unix_fd() only in dbus >= 1.1.1
-#if (DBUS_VERSION_MAJOR == 1 && DBUS_VERSION_MINOR == 1 && DBUS_VERSION_MICRO >= 1) || \
-		(DBUS_VERSION_MAJOR == 1 && DBUS_VERSION_MAJOR > 1) || \
-		(DBUS_VERSION_MAJOR > 1)
   return dbus_watch_get_unix_fd((DBusWatch *)_int);
-#else
-  return dbus_watch_get_fd((DBusWatch *)_int);
-#endif
 #endif
 }
 
@@ -313,7 +306,8 @@ void DBus::_init_threading(
     (DBusRecursiveMutexNewFunction) m1,
     (DBusRecursiveMutexFreeFunction) m2,
     (DBusRecursiveMutexLockFunction) m3,
-    (DBusRecursiveMutexUnlockFunction) m4
+    (DBusRecursiveMutexUnlockFunction) m4,
+    0, 0, 0, 0
   };
 #endif//DBUS_HAS_RECURSIVE_MUTEX
   dbus_threads_init(&functions);
diff --git a/src/eventloop.cpp b/src/eventloop.cpp
index 89177f7..7b3303a 100644
--- a/src/eventloop.cpp
+++ b/src/eventloop.cpp
@@ -154,7 +154,7 @@ void DefaultMainLoop::dispatch()
 
   int nfd = _watches.size();
 
-  if (_fdunlock)
+  if (_fdunlock[0] && _fdunlock[1])
   {
     nfd = nfd + 2;
   }
@@ -175,7 +175,7 @@ void DefaultMainLoop::dispatch()
     }
   }
 
-  if (_fdunlock)
+  if (_fdunlock[0] && _fdunlock[1])
   {
     fds[nfd].fd = _fdunlock[0];
     fds[nfd].events = POLLIN | POLLOUT | POLLPRI ;
-- 
2.7.4

