From 96fbaec29979834b184b5b40473ec2e338c3266c Mon Sep 17 00:00:00 2001
From: Simon Mikuda <simon.mikuda@streamunlimited.com>
Date: Thu, 30 Aug 2018 10:06:51 +0200
Subject: [PATCH] Add rate option to restrict supported sample rates

Signed-off-by: Simon Mikuda <simon.mikuda@streamunlimited.com>

%% original patch: 0020-Add-rate-option-to-restrict-supported-sample-rates.patch
---
 src/pcm/pcm_switch.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/src/pcm/pcm_switch.c b/src/pcm/pcm_switch.c
index 818a00b..4c599fa 100644
--- a/src/pcm/pcm_switch.c
+++ b/src/pcm/pcm_switch.c
@@ -57,6 +57,7 @@ typedef struct {
 	int cur_switch;
 	int active_switch;
 	int needs_update;
+	int restrict_rate;
 	snd_async_handler_t *async_handler;
 	int has_sw_params;
 	snd_pcm_sw_params_t sw_params;
@@ -257,6 +258,9 @@ static int snd_pcm_switch_hw_refine(snd_pcm_t *pcm, snd_pcm_hw_params_t *params)
 {
 	snd_pcm_switch_t *swtch = pcm->private_data;
 
+	if (swtch->restrict_rate)
+		snd_interval_refine_set(hw_param_interval(params, SND_PCM_HW_PARAM_RATE), swtch->restrict_rate);
+
 	if (swtch->gen.slave) {
 		DEBUG("copy");
 		return snd_pcm_hw_refine_slave(pcm, params,
@@ -1678,6 +1682,7 @@ int _snd_pcm_switch_open(snd_pcm_t **pcmp, const char *name,
 	snd_pcm_chmap_query_t **chmap = NULL;
 	int ctl_card = -1, cchannels = 2, err;
 	double drift_mult = 0;
+	long rate = 0;
 	const char *drift_elem_name = NULL;
 
 	snd_config_for_each(i, next, conf) {
@@ -1695,6 +1700,14 @@ int _snd_pcm_switch_open(snd_pcm_t **pcmp, const char *name,
 			control = n;
 			continue;
 		}
+		if (strcmp(id, "rate") == 0) {
+			err = snd_config_get_integer(n, &rate);
+			if (err < 0) {
+				SNDERR("Invalid rate config");
+				return err;
+			}
+			continue;
+		}
 		if (strcmp(id, "drift") == 0) {
 			err = snd_pcm_switch_parse_drift_config(n, &drift_elem_name, &drift_mult);
 			if (err < 0) {
@@ -1750,6 +1763,7 @@ int _snd_pcm_switch_open(snd_pcm_t **pcmp, const char *name,
 	swtch->gen.close_slave = 1;
 	swtch->gen.slave = NULL;
 	swtch->drift_mult = drift_mult;
+	swtch->restrict_rate = rate;
 
 	/* Store hw configuration to handle use cases when we are opening
 	 * swith plugin while it is disabled.
-- 
2.7.4

