From bf4e9c03514f8cc813271ab65154ccb31266beb7 Mon Sep 17 00:00:00 2001
From: Simon Mikuda <simon.mikuda@streamunlimited.com>
Date: Fri, 13 Oct 2017 11:00:10 +0200
Subject: [PATCH] Refine sample rate to kernel supported values

Signed-off-by: Simon Mikuda <simon.mikuda@streamunlimited.com>

%% original patch: 0016-Refine-sample-rate-to-kernel-supported-values.patch
---
 src/pcm/pcm_switch.c | 22 +++++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

diff --git a/src/pcm/pcm_switch.c b/src/pcm/pcm_switch.c
index 3a342c2..ff18a4a 100644
--- a/src/pcm/pcm_switch.c
+++ b/src/pcm/pcm_switch.c
@@ -18,6 +18,13 @@
 //#define TRACE(...) SNDERR(__VA_ARGS__)
 #define TRACE(...)
 
+// Kernel supported rates
+static unsigned int pcm_rates[] = { 5512, 8000, 11025, 16000, 22050, 32000, 44100,
+                                 48000, 64000, 88200, 96000, 176400, 192000,
+                                 352800, 384000, 705600, 768000, 1411200,
+                                 1536000, 2822400, 3072000 };
+unsigned pcm_rates_size = 21;
+
 enum {
 	SWITCH_CTL_OFF = 0,
 	SWITCH_CTL_ON,
@@ -250,7 +257,7 @@ static int snd_pcm_switch_hw_refine(snd_pcm_t *pcm, snd_pcm_hw_params_t *params)
 		DEBUG("null");
 
 		int err = 0;
-		unsigned int k;
+		unsigned int k, i, rate;
 
 		// If we have stored real hw params refine desired hw params also according to them
 		if (swtch->has_hw_params_any) {
@@ -267,6 +274,19 @@ static int snd_pcm_switch_hw_refine(snd_pcm_t *pcm, snd_pcm_hw_params_t *params)
 				if (!(params->rmask & (1 << k)))
 					continue;
 				err = snd_interval_refine(hw_param_interval(params, k), hw_param_interval(&swtch->hw_params_any, k));
+
+				// Refine to kernel supported values
+				if (k == SND_PCM_HW_PARAM_RATE) {
+					rate = params->intervals[k - SND_PCM_HW_PARAM_FIRST_INTERVAL].min;
+					if (rate == params->intervals[k - SND_PCM_HW_PARAM_FIRST_INTERVAL].max) {
+						for (i = 0; i < pcm_rates_size; ++i)
+							if (rate == pcm_rates[i])
+								break;
+						if (i == pcm_rates_size)
+							err = -1;
+					}
+				}
+
 				if (err) // error has negative values, change has positive value
 					params->cmask |= 1 << k;
 			}
-- 
2.7.4

