From dfee67d8d74409ac7fdfd1c9e734563df9b61250 Mon Sep 17 00:00:00 2001
From: Martin Flaska <martin.flaska@streamunlimited.com>
Date: Fri, 18 Jan 2013 12:36:05 +0100
Subject: [PATCH] tools: env: fixed advisory locking and broken compilation on
 the host platform

Signed-off-by: Martin Flaska <martin.flaska@streamunlimited.com>
---
 tools/env/fw_env_main.c | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/tools/env/fw_env_main.c b/tools/env/fw_env_main.c
index 2b85d78..42243c5 100644
--- a/tools/env/fw_env_main.c
+++ b/tools/env/fw_env_main.c
@@ -68,19 +68,27 @@ void usage(void)
 	);
 }
 
+#include <errno.h>
+
 int main(int argc, char *argv[])
 {
 	char *p;
 	char *cmdname = *argv;
 	char *script_file = NULL;
+	int print_default_env = 0;
 	int c;
 	const char *lockname = "/var/lock/" CMD_PRINTENV ".lock";
 	int lockfd = -1;
 	int retval = EXIT_SUCCESS;
+	struct flock lock;
 
-	lockfd = open(lockname, O_WRONLY | O_CREAT | O_TRUNC, 0666);
+	lock.l_type = F_RDLCK;
+	lock.l_len = 0;
+	lock.l_start = 0;
+	lock.l_whence = SEEK_SET;
+	lockfd = open(lockname, O_WRONLY | O_CREAT | O_TRUNC, &lock);
 	if (-1 == lockfd) {
-		fprintf(stderr, "Error opening lock file %s\n", lockname);
+		fprintf(stderr, "Error opening lock file '%s': %s\n", lockname, strerror(errno));
 		return EXIT_FAILURE;
 	}
 
@@ -136,5 +144,6 @@ int main(int argc, char *argv[])
 exit:
 	flock(lockfd, LOCK_UN);
 	close(lockfd);
+	remove(lockname);
 	return retval;
 }
-- 
2.7.4

