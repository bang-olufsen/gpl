From d3a413515a945e76da21b60286aeec7af685df88 Mon Sep 17 00:00:00 2001
From: Milan Plzik <milan.plzik@streamunlimited.com>
Date: Wed, 3 Dec 2014 16:22:47 +0100
Subject: [PATCH] correctly escape strings

Signed-off-by: Milan Plzik <milan.plzik@streamunlimited.com>
---
 src/librygel-renderer/rygel-av-transport.c    | 97 +++++++++++----------------
 src/librygel-renderer/rygel-av-transport.vala |  9 +--
 src/librygel-renderer/rygel-changelog.c       | 33 ++++++---
 src/librygel-renderer/rygel-changelog.vala    |  7 +-
 4 files changed, 72 insertions(+), 74 deletions(-)

diff --git a/src/librygel-renderer/rygel-av-transport.c b/src/librygel-renderer/rygel-av-transport.c
index 33de7cc..f8a6e91 100644
--- a/src/librygel-renderer/rygel-av-transport.c
+++ b/src/librygel-renderer/rygel-av-transport.c
@@ -706,28 +706,22 @@ static void rygel_av_transport_query_last_change_cb (RygelAVTransport* self, GUP
 	RygelPlayerControllerInterface* _tmp39_ = NULL;
 	const gchar* _tmp40_ = NULL;
 	const gchar* _tmp41_ = NULL;
-	gchar* _tmp42_ = NULL;
+	RygelPlayerControllerInterface* _tmp42_ = NULL;
 	gchar* _tmp43_ = NULL;
-	RygelPlayerControllerInterface* _tmp44_ = NULL;
+	gchar* _tmp44_ = NULL;
 	gchar* _tmp45_ = NULL;
-	gchar* _tmp46_ = NULL;
+	RygelPlayerControllerInterface* _tmp46_ = NULL;
 	gchar* _tmp47_ = NULL;
-	RygelPlayerControllerInterface* _tmp48_ = NULL;
+	gchar* _tmp48_ = NULL;
 	gchar* _tmp49_ = NULL;
-	gchar* _tmp50_ = NULL;
-	gchar* _tmp51_ = NULL;
-	gchar* _tmp52_ = NULL;
-	gchar* _tmp53_ = NULL;
-	RygelPlayerControllerInterface* _tmp54_ = NULL;
+	RygelPlayerControllerInterface* _tmp50_ = NULL;
+	const gchar* _tmp51_ = NULL;
+	const gchar* _tmp52_ = NULL;
+	RygelPlayerControllerInterface* _tmp53_ = NULL;
+	const gchar* _tmp54_ = NULL;
 	const gchar* _tmp55_ = NULL;
-	const gchar* _tmp56_ = NULL;
-	RygelPlayerControllerInterface* _tmp57_ = NULL;
-	const gchar* _tmp58_ = NULL;
-	const gchar* _tmp59_ = NULL;
-	gchar* _tmp60_ = NULL;
-	gchar* _tmp61_ = NULL;
-	gchar* _tmp62_ = NULL;
-	gchar* _tmp63_ = NULL;
+	gchar* _tmp56_ = NULL;
+	gchar* _tmp57_ = NULL;
 	g_return_if_fail (self != NULL);
 	g_return_if_fail (service != NULL);
 	g_return_if_fail (variable != NULL);
@@ -798,41 +792,32 @@ static void rygel_av_transport_query_last_change_cb (RygelAVTransport* self, GUP
 	_tmp39_ = self->priv->controller;
 	_tmp40_ = rygel_player_controller_interface_get_metadata (_tmp39_);
 	_tmp41_ = _tmp40_;
-	_tmp42_ = g_markup_escape_text (_tmp41_, (gssize) (-1));
-	_tmp43_ = _tmp42_;
-	rygel_change_log_log (log, "AVTransportURIMetaData", _tmp43_);
-	_g_free0 (_tmp43_);
-	_tmp44_ = self->priv->controller;
-	_tmp45_ = rygel_player_controller_interface_get_track_uri (_tmp44_);
-	_tmp46_ = _tmp45_;
-	_tmp47_ = _tmp46_;
-	rygel_change_log_log (log, "CurrentTrackURI", _tmp47_);
-	_g_free0 (_tmp47_);
-	_tmp48_ = self->priv->controller;
-	_tmp49_ = rygel_player_controller_interface_get_track_metadata (_tmp48_);
-	_tmp50_ = _tmp49_;
-	_tmp51_ = _tmp50_;
-	_tmp52_ = g_markup_escape_text (_tmp51_, (gssize) (-1));
-	_tmp53_ = _tmp52_;
-	rygel_change_log_log (log, "CurrentTrackMetaData", _tmp53_);
-	_g_free0 (_tmp53_);
-	_g_free0 (_tmp51_);
-	_tmp54_ = self->priv->controller;
-	_tmp55_ = rygel_player_controller_interface_get_next_uri (_tmp54_);
-	_tmp56_ = _tmp55_;
-	rygel_change_log_log (log, "NextAVTransportURI", _tmp56_);
-	_tmp57_ = self->priv->controller;
-	_tmp58_ = rygel_player_controller_interface_get_next_metadata (_tmp57_);
-	_tmp59_ = _tmp58_;
-	_tmp60_ = g_markup_escape_text (_tmp59_, (gssize) (-1));
-	_tmp61_ = _tmp60_;
-	rygel_change_log_log (log, "NextAVTransportURIMetaData", _tmp61_);
-	_g_free0 (_tmp61_);
+	rygel_change_log_log (log, "AVTransportURIMetaData", _tmp41_);
+	_tmp42_ = self->priv->controller;
+	_tmp43_ = rygel_player_controller_interface_get_track_uri (_tmp42_);
+	_tmp44_ = _tmp43_;
+	_tmp45_ = _tmp44_;
+	rygel_change_log_log (log, "CurrentTrackURI", _tmp45_);
+	_g_free0 (_tmp45_);
+	_tmp46_ = self->priv->controller;
+	_tmp47_ = rygel_player_controller_interface_get_track_metadata (_tmp46_);
+	_tmp48_ = _tmp47_;
+	_tmp49_ = _tmp48_;
+	rygel_change_log_log (log, "CurrentTrackMetaData", _tmp49_);
+	_g_free0 (_tmp49_);
+	_tmp50_ = self->priv->controller;
+	_tmp51_ = rygel_player_controller_interface_get_next_uri (_tmp50_);
+	_tmp52_ = _tmp51_;
+	rygel_change_log_log (log, "NextAVTransportURI", _tmp52_);
+	_tmp53_ = self->priv->controller;
+	_tmp54_ = rygel_player_controller_interface_get_next_metadata (_tmp53_);
+	_tmp55_ = _tmp54_;
+	rygel_change_log_log (log, "NextAVTransportURIMetaData", _tmp55_);
 	g_value_init (value, G_TYPE_STRING);
-	_tmp62_ = rygel_change_log_finish (log);
-	_tmp63_ = _tmp62_;
-	g_value_set_string (value, _tmp63_);
-	_g_free0 (_tmp63_);
+	_tmp56_ = rygel_change_log_finish (log);
+	_tmp57_ = _tmp56_;
+	g_value_set_string (value, _tmp57_);
+	_g_free0 (_tmp57_);
 	_g_object_unref0 (log);
 }
 
@@ -1646,7 +1631,7 @@ static void rygel_av_transport_seek_cb (RygelAVTransport* self, GUPnPService* se
 				_tmp8_ = rygel_time_utils_time_from_string (_tmp7_);
 				seek_target = _tmp8_;
 				_tmp9_ = seek_target;
-				g_debug ("rygel-av-transport.vala:519: Seeking to %lld sec", _tmp9_ / G_TIME_SPAN_SECOND);
+				g_debug ("rygel-av-transport.vala:516: Seeking to %lld sec", _tmp9_ / G_TIME_SPAN_SECOND);
 				_tmp10_ = self->priv->player;
 				_tmp11_ = rygel_media_player_get_can_seek (_tmp10_);
 				_tmp12_ = _tmp11_;
@@ -1712,7 +1697,7 @@ static void rygel_av_transport_seek_cb (RygelAVTransport* self, GUPnPService* se
 					seek_target = _tmp24_ + _tmp27_;
 				}
 				_tmp28_ = seek_target;
-				g_debug ("rygel-av-transport.vala:544: Seeking to %lld bytes.", _tmp28_);
+				g_debug ("rygel-av-transport.vala:541: Seeking to %lld bytes.", _tmp28_);
 				_tmp29_ = self->priv->player;
 				_tmp30_ = rygel_media_player_get_can_seek_bytes (_tmp29_);
 				_tmp31_ = _tmp30_;
@@ -1760,7 +1745,7 @@ static void rygel_av_transport_seek_cb (RygelAVTransport* self, GUPnPService* se
 				gint _tmp52_ = 0;
 				GUPnPServiceAction* _tmp53_ = NULL;
 				_tmp40_ = target;
-				g_debug ("rygel-av-transport.vala:562: Setting track to %s.", _tmp40_);
+				g_debug ("rygel-av-transport.vala:559: Setting track to %s.", _tmp40_);
 				_tmp41_ = target;
 				_tmp42_ = atoi (_tmp41_);
 				track = _tmp42_;
@@ -2575,7 +2560,7 @@ static void rygel_av_transport_check_resource (RygelAVTransport* self, SoupMessa
 		SoupSession* _tmp22_ = NULL;
 		SoupMessage* _tmp23_ = NULL;
 		SoupMessage* _tmp24_ = NULL;
-		g_debug ("rygel-av-transport.vala:750: Peer does not support HEAD, trying GET");
+		g_debug ("rygel-av-transport.vala:747: Peer does not support HEAD, trying GET");
 		_tmp20_ = msg;
 		g_object_set (_tmp20_, "method", "GET", NULL);
 		_tmp21_ = msg;
@@ -2646,7 +2631,7 @@ static void rygel_av_transport_check_resource (RygelAVTransport* self, SoupMessa
 		GUPnPServiceAction* _tmp53_ = NULL;
 		const gchar* _tmp54_ = NULL;
 		_tmp52_ = mime;
-		g_debug ("rygel-av-transport.vala:783: Unsupported mime type %s", _tmp52_);
+		g_debug ("rygel-av-transport.vala:780: Unsupported mime type %s", _tmp52_);
 		_tmp53_ = action;
 		_tmp54_ = _ ("Illegal MIME-type");
 		gupnp_service_action_return_error (_tmp53_, (guint) 714, _tmp54_);
diff --git a/src/librygel-renderer/rygel-av-transport.vala b/src/librygel-renderer/rygel-av-transport.vala
index eff864a..d4cdf07 100644
--- a/src/librygel-renderer/rygel-av-transport.vala
+++ b/src/librygel-renderer/rygel-av-transport.vala
@@ -174,14 +174,11 @@ internal class Rygel.AVTransport : Service {
         log.log ("CurrentTrackDuration",         this.player.duration_as_str);
         log.log ("CurrentMediaDuration",         this.player.duration_as_str);
         log.log ("AVTransportURI",               this.controller.uri);
-        log.log ("AVTransportURIMetaData",
-                 Markup.escape_text (this.controller.metadata));
+        log.log ("AVTransportURIMetaData",       this.controller.metadata);
         log.log ("CurrentTrackURI",              this.controller.track_uri);
-        log.log ("CurrentTrackMetaData",
-                 Markup.escape_text (this.controller.track_metadata));
+        log.log ("CurrentTrackMetaData",         this.controller.track_metadata);
         log.log ("NextAVTransportURI",           this.controller.next_uri);
-        log.log ("NextAVTransportURIMetaData",
-                 Markup.escape_text (this.controller.next_metadata));
+        log.log ("NextAVTransportURIMetaData",   this.controller.next_metadata);
 
         value.init (typeof (string));
         value.set_string (log.finish ());
diff --git a/src/librygel-renderer/rygel-changelog.c b/src/librygel-renderer/rygel-changelog.c
index 877b5d5..dbf997a 100644
--- a/src/librygel-renderer/rygel-changelog.c
+++ b/src/librygel-renderer/rygel-changelog.c
@@ -178,6 +178,8 @@ void rygel_change_log_log (RygelChangeLog* self, const gchar* variable, const gc
 	const gchar* _tmp5_ = NULL;
 	gchar* _tmp6_ = NULL;
 	gchar* _tmp7_ = NULL;
+	gchar* _tmp8_ = NULL;
+	gchar* _tmp9_ = NULL;
 	g_return_if_fail (self != NULL);
 	g_return_if_fail (variable != NULL);
 	g_return_if_fail (value != NULL);
@@ -188,9 +190,12 @@ void rygel_change_log_log (RygelChangeLog* self, const gchar* variable, const gc
 	_tmp3_ = variable;
 	_tmp4_ = variable;
 	_tmp5_ = value;
-	_tmp6_ = g_strdup_printf ("<%s val=\"%s\"/>", _tmp4_, _tmp5_);
+	_tmp6_ = g_markup_escape_text (_tmp5_, (gssize) (-1));
 	_tmp7_ = _tmp6_;
-	gee_abstract_map_set ((GeeAbstractMap*) _tmp2_, _tmp3_, _tmp7_);
+	_tmp8_ = g_strdup_printf ("<%s val=\"%s\"/>", _tmp4_, _tmp7_);
+	_tmp9_ = _tmp8_;
+	gee_abstract_map_set ((GeeAbstractMap*) _tmp2_, _tmp3_, _tmp9_);
+	_g_free0 (_tmp9_);
 	_g_free0 (_tmp7_);
 	rygel_change_log_ensure_timeout (self);
 }
@@ -201,9 +206,13 @@ void rygel_change_log_log_with_channel (RygelChangeLog* self, const gchar* varia
 	const gchar* _tmp1_ = NULL;
 	const gchar* _tmp2_ = NULL;
 	const gchar* _tmp3_ = NULL;
-	const gchar* _tmp4_ = NULL;
+	gchar* _tmp4_ = NULL;
 	gchar* _tmp5_ = NULL;
-	gchar* _tmp6_ = NULL;
+	const gchar* _tmp6_ = NULL;
+	gchar* _tmp7_ = NULL;
+	gchar* _tmp8_ = NULL;
+	gchar* _tmp9_ = NULL;
+	gchar* _tmp10_ = NULL;
 	g_return_if_fail (self != NULL);
 	g_return_if_fail (variable != NULL);
 	g_return_if_fail (value != NULL);
@@ -212,11 +221,17 @@ void rygel_change_log_log_with_channel (RygelChangeLog* self, const gchar* varia
 	_tmp1_ = variable;
 	_tmp2_ = variable;
 	_tmp3_ = value;
-	_tmp4_ = channel;
-	_tmp5_ = g_strdup_printf ("<%s val=\"%s\" channel=\"%s\"/>", _tmp2_, _tmp3_, _tmp4_);
-	_tmp6_ = _tmp5_;
-	gee_abstract_map_set ((GeeAbstractMap*) _tmp0_, _tmp1_, _tmp6_);
-	_g_free0 (_tmp6_);
+	_tmp4_ = g_markup_escape_text (_tmp3_, (gssize) (-1));
+	_tmp5_ = _tmp4_;
+	_tmp6_ = channel;
+	_tmp7_ = g_markup_escape_text (_tmp6_, (gssize) (-1));
+	_tmp8_ = _tmp7_;
+	_tmp9_ = g_strdup_printf ("<%s val=\"%s\" channel=\"%s\"/>", _tmp2_, _tmp5_, _tmp8_);
+	_tmp10_ = _tmp9_;
+	gee_abstract_map_set ((GeeAbstractMap*) _tmp0_, _tmp1_, _tmp10_);
+	_g_free0 (_tmp10_);
+	_g_free0 (_tmp8_);
+	_g_free0 (_tmp5_);
 	rygel_change_log_ensure_timeout (self);
 }
 
diff --git a/src/librygel-renderer/rygel-changelog.vala b/src/librygel-renderer/rygel-changelog.vala
index 00f4763..6f54c92 100644
--- a/src/librygel-renderer/rygel-changelog.vala
+++ b/src/librygel-renderer/rygel-changelog.vala
@@ -72,7 +72,8 @@ internal class Rygel.ChangeLog : Object {
 
     public void log (string variable, string value) {
         debug (@"'%s = %s' logged", variable, value);
-        this.hash.set (variable, "<%s val=\"%s\"/>".printf (variable, value));
+        this.hash.set (variable, "<%s val=\"%s\"/>".printf (variable,
+                                                            Markup.escape_text(value)));
 
         this.ensure_timeout ();
     }
@@ -82,8 +83,8 @@ internal class Rygel.ChangeLog : Object {
                                   string channel) {
         this.hash.set (variable,
                        "<%s val=\"%s\" channel=\"%s\"/>".printf (variable,
-                                                                 value,
-                                                                 channel));
+                                                                 Markup.escape_text(value),
+                                                                 Markup.escape_text(channel)));
 
         this.ensure_timeout ();
     }
-- 
1.9.1

